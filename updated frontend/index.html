<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediQueue</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Auth Pages */
        .auth-container {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-switch a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .top-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .top-bar-left h2 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .top-bar-left p {
            color: #666;
            font-size: 14px;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: right;
            margin-right: 15px;
        }

        .user-info .name {
            font-weight: 600;
            color: #333;
        }

        .user-info .role {
            font-size: 12px;
            color: #667eea;
            text-transform: uppercase;
            font-weight: 600;
        }

        .btn-logout {
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-logout:hover {
            background: #c82333;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-card.critical .value {
            color: #dc3545;
        }

        .stat-card.warning .value {
            color: #ffc107;
        }

        .stat-card.success .value {
            color: #28a745;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-label {
            width: 120px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .chart-bar-bg {
            flex: 1;
            height: 30px;
            background: #f0f0f0;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .chart-bar-fill {
            height: 100%;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            transition: width 0.5s ease;
        }

        .chart-bar-fill.critical { background: #dc3545; }
        .chart-bar-fill.emergency { background: #ff6b6b; }
        .chart-bar-fill.urgent { background: #ffc107; color: #333; }
        .chart-bar-fill.semiurgent { background: #17a2b8; }
        .chart-bar-fill.nonurgent { background: #28a745; }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: #f0f0f0;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        .content-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        /* Patient List */
        .patient-list {
            display: grid;
            gap: 15px;
        }

        .patient-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .patient-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .patient-card.critical {
            border-left-color: #dc3545;
        }

        .patient-card.emergency {
            border-left-color: #ff6b6b;
        }

        .patient-card.urgent {
            border-left-color: #ffc107;
        }

        .patient-card.semi-urgent,
        .patient-card.semiurgent {
            border-left-color: #17a2b8;
        }

        .patient-card.non-urgent,
        .patient-card.nonurgent {
            border-left-color: #28a745;
        }

        .patient-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .patient-card-header h3 {
            color: #333;
            font-size: 18px;
        }

        .severity-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-badge.critical {
            background: #dc3545;
            color: white;
        }

        .severity-badge.emergency {
            background: #ff6b6b;
            color: white;
        }

        .severity-badge.urgent {
            background: #ffc107;
            color: #333;
        }

        .severity-badge.semi-urgent,
        .severity-badge.semiurgent {
            background: #17a2b8;
            color: white;
        }

        .severity-badge.non-urgent,
        .severity-badge.nonurgent {
            background: #28a745;
            color: white;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.waiting {
            background: #ffc107;
            color: #333;
        }

        .status-badge.in-treatment {
            background: #17a2b8;
            color: white;
        }

        .status-badge.completed {
            background: #28a745;
            color: white;
        }

        .status-badge.discharged {
            background: #6c757d;
            color: white;
        }

        .status-badge.referred {
            background: #6f42c1;
            color: white;
        }

        .patient-card-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-item .value {
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Form Layouts */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            display: inline-block;
            margin-right: 10px;
            margin-top: 10px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        /* Wait Time Badge */
        .wait-time-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .top-bar-right {
                flex-direction: column;
                width: 100%;
            }

            .user-info {
                text-align: center;
                margin-right: 0;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .search-box {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Page -->
        <div id="loginPage" class="auth-container" style="text-align: center;">
            <img src="logo.png" style="height:100px;width: 100px;">
            <div class="auth-header">
                <h1>üè• Welcome To MediQueue</h1>
                <p>Sign in to continue</p>
            </div>
            <div id="loginAlert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="National ID (10 digits) or Employee ID (6 digits)" required>
                    <small style="color: #666; font-size: 12px;">Patients: 10-digit National ID | Staff: 6-digit Employee ID</small>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn">Sign In</button>
            </form>
            <div class="auth-switch">
                New patient? <a onclick="showSetPassword()">Set password here</a>
            </div>
        </div>

        <!-- Set Password Page -->
        <div id="setPasswordPage" class="auth-container hidden">
            <div class="auth-header">
                <h1>üè• Set Your Password</h1>
                <p>Create your account password to access your medical records</p>
            </div>
            <div id="setPasswordAlert"></div>
            <form id="setPasswordForm">
                <div class="form-group">
                    <label>National ID (10 digits) *</label>
                    <input type="text" id="setPasswordNationalId" maxlength="10" pattern="[0-9]{10}" required>
                </div>
                <div class="form-group">
                    <label>Password (min 6 chars) *</label>
                    <input type="password" id="setPasswordPassword" minlength="6" required>
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <input type="password" id="setPasswordConfirmPassword" minlength="6" required>
                </div>
                <button type="submit" class="btn">Set Password</button>
                <button type="button" class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <div class="top-bar">
                <div class="top-bar-left">
                    <h2 id="dashboardTitle">Dashboard</h2>
                    <p id="dashboardSubtitle">Welcome back</p>
                </div>
                <div class="top-bar-right">
                    <div class="user-info">
                        <div class="name" id="userName">Loading...</div>
                        <div class="role" id="userRole">...</div>
                    </div>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </div>

            <div id="statsContainer" class="stats-grid"></div>
            <div id="chartsContainer"></div>

            <div class="nav-tabs" id="navTabs"></div>

            <div id="contentContainer"></div>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div id="patientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Patient Details</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                loadUserData();
            } else {
                showLogin();
            }
        });

        // Utility Functions
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function getSeverityClass(severity) {
            if (!severity) return '';
            const s = severity.toLowerCase().replace(/[^a-z]/g, '');
            return s;
        }

        function getStatusClass(status) {
            if (!status) return '';
            return status.toLowerCase().replace(/ /g, '-');
        }
        
        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function calculateAge(dob) {
            if (!dob) return 'N/A';
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function formatWaitTime(minutes) {
            if (!minutes) return 'N/A';
            if (minutes < 60) return `${minutes} minutes`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours} hour${hours > 1 ? 's' : ''} ${mins > 0 ? `${mins} min${mins > 1 ? 's' : ''}` : ''}`;
        }

        // Auth Functions
        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('setPasswordPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('active');
        }

        function showSetPassword() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('setPasswordPage').classList.remove('hidden');
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showAlert('loginAlert', 'Login successful!', 'success');
                    setTimeout(() => loadUserData(), 500);
                } else if (data.first_login) {
                    showAlert('loginAlert', data.message, 'info');
                    showSetPassword();
                } else {
                    showAlert('loginAlert', data.message || data.detail || 'Login failed', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'Connection error. Please try again.', 'error');
            }
        });

        document.getElementById('setPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nationalId = document.getElementById('setPasswordNationalId').value;
            const password = document.getElementById('setPasswordPassword').value;
            const confirmPassword = document.getElementById('setPasswordConfirmPassword').value;

            if (password !== confirmPassword) {
                showAlert('setPasswordAlert', 'Passwords do not match', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/auth/set-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ national_id: nationalId, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showAlert('setPasswordAlert', 'Password set successfully! Signing you in...', 'success');
                    setTimeout(() => loadUserData(), 1500);
                } else {
                    showAlert('setPasswordAlert', data.detail || data.message || 'Failed to set password', 'error');
                }
            } catch (error) {
                showAlert('setPasswordAlert', 'Connection error. Please try again.', 'error');
            }
        });

        async function loadUserData() {
            try {
                const response = await fetch(`${API_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    showDashboard();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function logout() {
            fetch(`${API_URL}/api/auth/logout`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${authToken}` }
            }).finally(() => {
                localStorage.removeItem('authToken');
                authToken = null;
                currentUser = null;
                location.reload();
            });
        }

        // Dashboard Navigation
        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            const activeTab = Array.from(document.querySelectorAll('.nav-tab')).find(t => t.textContent.toLowerCase().includes(tabId.toLowerCase()));
            if (activeTab) activeTab.classList.add('active');

            const contentContainer = document.getElementById('contentContainer');
            contentContainer.innerHTML = `<div id="${tabId}Section" class="content-section active"></div>`;
            
            if (tabId === 'history') loadTriageHistory();
            if (tabId === 'profile') loadProfile();
            if (tabId === 'triage') loadTriageForm();
            if (tabId === 'patients') loadAllPatients();
            if (tabId === 'analytics') loadAnalytics();
            if (tabId === 'register') loadPatientRegistration();
        }

        // Dashboard Functions
        async function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('setPasswordPage').classList.add('hidden');
            document.getElementById('dashboard').classList.add('active');

            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;

            if (currentUser.role === 'patient') {
                await loadPatientDashboard();
            } else if (currentUser.role === 'nurse') {
                await loadNurseDashboard();
            } else if (currentUser.role === 'doctor') {
                await loadDoctorDashboard();
            } else if (currentUser.role === 'admin') {
                await loadAdminDashboard();
            }
        }

        async function loadPatientDashboard() {
            document.getElementById('dashboardTitle').textContent = 'Patient Dashboard';
            document.getElementById('dashboardSubtitle').textContent = 'Your medical records and triage history';

            try {
                const statsResponse = await fetch(`${API_URL}/api/stats/dashboard`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const statsData = await statsResponse.json();

                const statsHTML = `
                    <div class="stat-card">
                        <h3>Total Visits</h3>
                        <div class="value">${statsData.stats.total_visits || 0}</div>
                    </div>
                    <div class="stat-card ${getSeverityClass(statsData.stats.latest_severity)}">
                        <h3>Latest Severity</h3>
                        <div class="value">${statsData.stats.latest_severity || 'None'}</div>
                    </div>
                    <div class="stat-card ${getStatusClass(statsData.stats.latest_status)}">
                        <h3>Current Status</h3>
                        <div class="value">${statsData.stats.latest_status || 'N/A'}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Estimated Wait Time</h3>
                        <div class="value">${formatWaitTime(statsData.stats.latest_wait_time)}</div>
                    </div>
                `;
                document.getElementById('statsContainer').innerHTML = statsHTML;
            } catch (error) {
                document.getElementById('statsContainer').innerHTML = '<div class="alert alert-error">Error loading statistics</div>';
            }

            const navHTML = `
                <button class="nav-tab active" onclick="switchTab('history')">My Triage History</button>
                <button class="nav-tab" onclick="switchTab('profile')">My Profile</button>
            `;
            document.getElementById('navTabs').innerHTML = navHTML;

            await loadTriageHistory();
        }

        async function loadNurseDashboard() {
            document.getElementById('dashboardTitle').textContent = 'Nurse Dashboard';
            document.getElementById('dashboardSubtitle').textContent = 'Perform patient triage assessments';

            try {
                const statsResponse = await fetch(`${API_URL}/api/stats/dashboard`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const statsData = await statsResponse.json();

                const statsHTML = `
                    <div class="stat-card">
                        <h3>Waiting Patients</h3>
                        <div class="value">${statsData.stats.waiting || 0}</div>
                    </div>
                    <div class="stat-card critical">
                        <h3>Critical Waiting</h3>
                        <div class="value">${statsData.stats.critical_waiting || 0}</div>
                    </div>
                    <div class="stat-card warning">
                        <h3>Emergency Waiting</h3>
                        <div class="value">${statsData.stats.emergency_waiting || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>My Triages</h3>
                        <div class="value">${statsData.stats.my_triages_performed || 0}</div>
                    </div>
                `;
                document.getElementById('statsContainer').innerHTML = statsHTML;
            } catch (error) {
                document.getElementById('statsContainer').innerHTML = '<div class="alert alert-error">Error loading statistics</div>';
            }

            const navHTML = `
                <button class="nav-tab active" onclick="switchTab('register')">Register Patient</button>
                <button class="nav-tab" onclick="switchTab('triage')">Perform Triage</button>
                <button class="nav-tab" onclick="switchTab('patients')">All Patients</button>
                <button class="nav-tab" onclick="switchTab('profile')">My Profile</button>
            `;
            document.getElementById('navTabs').innerHTML = navHTML;

            await loadPatientRegistration();
        }

        async function loadDoctorDashboard() {
            document.getElementById('dashboardTitle').textContent = 'Doctor Dashboard';
            document.getElementById('dashboardSubtitle').textContent = 'Manage patient treatment and care';

            try {
                const statsResponse = await fetch(`${API_URL}/api/stats/dashboard`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const statsData = await statsResponse.json();

                const statsHTML = `
                    <div class="stat-card">
                        <h3>Total Patients</h3>
                        <div class="value">${statsData.stats.total_patients || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>In Treatment</h3>
                        <div class="value">${statsData.stats.in_treatment || 0}</div>
                    </div>
                    <div class="stat-card critical">
                        <h3>Critical Waiting</h3>
                        <div class="value">${statsData.stats.critical_waiting || 0}</div>
                    </div>
                    <div class="stat-card success">
                        <h3>Completed</h3>
                        <div class="value">${statsData.stats.completed || 0}</div>
                    </div>
                `;
                document.getElementById('statsContainer').innerHTML = statsHTML;
            } catch (error) {
                document.getElementById('statsContainer').innerHTML = '<div class="alert alert-error">Error loading statistics</div>';
            }

            const navHTML = `
                <button class="nav-tab active" onclick="switchTab('patients')">All Patients</button>
                <button class="nav-tab" onclick="switchTab('profile')">My Profile</button>
            `;
            document.getElementById('navTabs').innerHTML = navHTML;

            await loadAllPatients();
        }

        async function loadAdminDashboard() {
            document.getElementById('dashboardTitle').textContent = 'Admin Dashboard';
            document.getElementById('dashboardSubtitle').textContent = 'System overview and management';

            try {
                const statsResponse = await fetch(`${API_URL}/api/stats/dashboard`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const statsData = await statsResponse.json();

                const statsHTML = `
                    <div class="stat-card">
                        <h3>Total Patients</h3>
                        <div class="value">${statsData.stats.total_patients || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Today's Patients</h3>
                        <div class="value">${statsData.stats.today_patients || 0}</div>
                    </div>
                    <div class="stat-card warning">
                        <h3>Waiting</h3>
                        <div class="value">${statsData.stats.waiting || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Average Wait Time</h3>
                        <div class="value">${formatWaitTime(statsData.stats.average_wait_time)}</div>
                    </div>
                `;
                document.getElementById('statsContainer').innerHTML = statsHTML;

                // Clear charts container - don't show by default
                document.getElementById('chartsContainer').innerHTML = '';
            } catch (error) {
                document.getElementById('statsContainer').innerHTML = '<div class="alert alert-error">Error loading statistics</div>';
            }

            const navHTML = `
                <button class="nav-tab active" onclick="switchTab('patients')">All Patients</button>
                <button class="nav-tab" onclick="switchTab('analytics')">Analytics</button>
                <button class="nav-tab" onclick="switchTab('profile')">My Profile</button>
            `;
            document.getElementById('navTabs').innerHTML = navHTML;

            await loadAllPatients();
        }

        async function loadAdminCharts(stats) {
            const response = await fetch(`${API_URL}/api/triage/patients`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const data = await response.json();
            
            if (!data.patients) return;

            const severityCounts = {
                'Critical': 0,
                'Emergency': 0,
                'Urgent': 0,
                'Semi-Urgent': 0,
                'Non-Urgent': 0
            };

            const statusCounts = {
                'Waiting': 0,
                'In Treatment': 0,
                'Completed': 0,
                'Discharged': 0,
                'Referred': 0
            };

            data.patients.forEach(p => {
                if (severityCounts[p.severity] !== undefined) {
                    severityCounts[p.severity]++;
                }
                if (statusCounts[p.status] !== undefined) {
                    statusCounts[p.status]++;
                }
            });

            const maxSeverity = Math.max(...Object.values(severityCounts), 1);
            const maxStatus = Math.max(...Object.values(statusCounts), 1);

            const chartsHTML = `
                <div class="chart-container">
                    <h3>Patients by Severity Level</h3>
                    ${Object.entries(severityCounts).map(([severity, count]) => `
                        <div class="chart-bar">
                            <div class="chart-label">${severity}</div>
                            <div class="chart-bar-bg">
                                <div class="chart-bar-fill ${getSeverityClass(severity)}" 
                                     style="width: ${(count / maxSeverity) * 100}%">
                                    ${count}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="chart-container">
                    <h3>Patients by Status</h3>
                    ${Object.entries(statusCounts).map(([status, count]) => `
                        <div class="chart-bar">
                            <div class="chart-label">${status}</div>
                            <div class="chart-bar-bg">
                                <div class="chart-bar-fill ${getStatusClass(status)}" 
                                     style="width: ${(count / maxStatus) * 100}%; background: ${getStatusColor(status)}">
                                    ${count}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('chartsContainer').innerHTML = chartsHTML;
        }

        function getStatusColor(status) {
            const colors = {
                'Waiting': '#ffc107',
                'In Treatment': '#17a2b8',
                'Completed': '#28a745',
                'Discharged': '#6c757d',
                'Referred': '#6f42c1'
            };
            return colors[status] || '#667eea';
        }

        async function loadTriageHistory() {
            const historySection = document.getElementById('historySection');
            if (!historySection) return;
            historySection.innerHTML = '<h2>My Triage History</h2><div class="loading">Loading your triage records</div>';

            try {
                const response = await fetch(`${API_URL}/api/triage/history`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch history');
                const data = await response.json();

                if (!data.records || data.records.length === 0) {
                    historySection.innerHTML = '<h2>My Triage History</h2><div class="alert alert-info">No triage records found.</div>';
                    return;
                }

                const listHTML = data.records.map(record => {
                    const severityClass = getSeverityClass(record.severity);
                    const statusClass = getStatusClass(record.status);
                    return `
                        <div class="patient-card ${severityClass}" onclick="openPatientModal('${record.patient_id}')">
                            <div class="patient-card-header">
                                <h3>Visit ID: ${record.patient_id}</h3>
                                <div>
                                    <span class="severity-badge ${severityClass}">${record.severity}</span>
                                    <span class="status-badge ${statusClass}">${record.status}</span>
                                </div>
                            </div>
                            <div class="patient-card-body">
                                <div><strong>Date:</strong> ${formatDateTime(record.timestamp)}</div>
                                <div><strong>Complaint:</strong> ${record.patient_complaint}</div>
                                <div><strong>Confidence:</strong> ${record.confidence.toFixed(1)}%</div>
                                <div><strong>Nurse:</strong> ${record.nurse_name || record.created_by}</div>
                                ${record.estimated_wait_time ? `<div><strong>Est. Wait Time:</strong> ${formatWaitTime(record.estimated_wait_time)}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                historySection.innerHTML = `
                    <h2>My Triage History (${data.total} records)</h2>
                    <div class="patient-list">${listHTML}</div>
                `;
            } catch (error) {
                historySection.innerHTML = `<h2>My Triage History</h2><div class="alert alert-error">Error loading history: ${error.message}</div>`;
            }
        }

        async function loadAllPatients() {
            const patientsSection = document.getElementById('patientsSection');
            if (!patientsSection) return;
            patientsSection.innerHTML = '<h2>All Patients</h2><div class="loading">Loading patient queue</div>';

            try {
                const response = await fetch(`${API_URL}/api/triage/patients`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch patients');
                const data = await response.json();

                if (!data.patients || data.patients.length === 0) {
                    patientsSection.innerHTML = '<h2>All Patients</h2><div class="alert alert-info">No patients in queue.</div>';
                    return;
                }

                let filterOptions = '';
                if (currentUser.role === 'admin') {
                    filterOptions = `
                        <select id="adminFilter">
                            <option value="">All Records</option>
                            <option value="waiting">Waiting</option>
                            <option value="in_treatment">In Treatment</option>
                            <option value="completed">Completed</option>
                            <option value="critical">Critical</option>
                            <option value="emergency">Emergency</option>
                            <option value="today">Today's Patients</option>
                        </select>
                    `;
                }

                patientsSection.innerHTML = `
                    <h2>All Patients (${data.total} total)</h2>
                    <div class="search-box">
                        <input type="text" id="patientSearch" placeholder="Search by Patient ID, Name, or National ID...">
                        <select id="severityFilter">
                            <option value="">All Severities</option>
                            <option value="Critical">Critical</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Urgent">Urgent</option>
                            <option value="Semi-Urgent">Semi-Urgent</option>
                            <option value="Non-Urgent">Non-Urgent</option>
                        </select>
                        <select id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="Waiting">Waiting</option>
                            <option value="In Treatment">In Treatment</option>
                            <option value="Completed">Completed</option>
                            <option value="Discharged">Discharged</option>
                            <option value="Referred">Referred</option>
                        </select>
                        ${filterOptions}
                    </div>
                    <div id="patientListContainer"></div>
                `;

                const allPatients = data.patients;
                
                function renderFilteredPatients() {
                    const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
                    const severityFilter = document.getElementById('severityFilter').value;
                    const statusFilter = document.getElementById('statusFilter').value;
                    const adminFilter = currentUser.role === 'admin' ? 
                        document.getElementById('adminFilter')?.value || '' : '';

                    let filtered = allPatients.filter(p => {
                        const matchesSearch = !searchTerm || 
                            p.patient_id.toLowerCase().includes(searchTerm) ||
                            p.name.toLowerCase().includes(searchTerm) ||
                            (p.national_id && p.national_id.includes(searchTerm));
                        const matchesSeverity = !severityFilter || p.severity === severityFilter;
                        const matchesStatus = !statusFilter || p.status === statusFilter;
                        
                        let matchesAdminFilter = true;
                        if (adminFilter) {
                            switch(adminFilter) {
                                case 'waiting':
                                    matchesAdminFilter = p.status === 'Waiting';
                                    break;
                                case 'in_treatment':
                                    matchesAdminFilter = p.status === 'In Treatment';
                                    break;
                                case 'completed':
                                    matchesAdminFilter = p.status === 'Completed';
                                    break;
                                case 'critical':
                                    matchesAdminFilter = p.severity === 'Critical';
                                    break;
                                case 'emergency':
                                    matchesAdminFilter = p.severity === 'Emergency';
                                    break;
                                case 'today':
                                    const today = new Date();
                                    const patientDate = new Date(p.timestamp);
                                    matchesAdminFilter = patientDate.toDateString() === today.toDateString();
                                    break;
                            }
                        }
                        
                        return matchesSearch && matchesSeverity && matchesStatus && matchesAdminFilter;
                    });

                    const listHTML = filtered.map(p => {
                        const severityClass = getSeverityClass(p.severity);
                        const statusClass = getStatusClass(p.status);
                        return `
                            <div class="patient-card ${severityClass}" onclick="openPatientModal('${p.patient_id}')">
                                <div class="patient-card-header">
                                    <h3>${p.name} (${p.patient_id})</h3>
                                    <div>
                                        <span class="severity-badge ${severityClass}">${p.severity}</span>
                                        <span class="status-badge ${statusClass}">${p.status}</span>
                                        ${p.estimated_wait_time ? `<span class="wait-time-badge">${formatWaitTime(p.estimated_wait_time)}</span>` : ''}
                                    </div>
                                </div>
                                <div class="patient-card-body">
                                    <div><strong>Age:</strong> ${p.age} | <strong>Gender:</strong> ${p.gender}</div>
                                    <div><strong>Complaint:</strong> ${p.patient_complaint}</div>
                                    <div><strong>Arrived:</strong> ${formatDateTime(p.timestamp)}</div>
                                    <div><strong>Confidence:</strong> ${p.confidence.toFixed(1)}%</div>
                                    <div><strong>Nurse:</strong> ${p.nurse_name || p.created_by}</div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    document.getElementById('patientListContainer').innerHTML = 
                        filtered.length > 0 ? `<div class="patient-list">${listHTML}</div>` : 
                        '<div class="alert alert-info">No patients match your filters.</div>';
                }

                document.getElementById('patientSearch').addEventListener('input', renderFilteredPatients);
                document.getElementById('severityFilter').addEventListener('change', renderFilteredPatients);
                document.getElementById('statusFilter').addEventListener('change', renderFilteredPatients);
                
                if (currentUser.role === 'admin') {
                    document.getElementById('adminFilter').addEventListener('change', renderFilteredPatients);
                }
                
                renderFilteredPatients();
            } catch (error) {
                patientsSection.innerHTML = `<h2>All Patients</h2><div class="alert alert-error">Error loading patients: ${error.message}</div>`;
            }
        }

        async function loadProfile() {
            const profileSection = document.getElementById('profileSection');
            if (!profileSection) return;
            profileSection.innerHTML = '<h2>My Profile</h2><div class="loading">Loading profile information</div>';

            try {
                const response = await fetch(`${API_URL}/api/user/complete-data`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch profile');
                const data = await response.json();

                const user = data.user_info;
                const profile = data.profile_info;

                let profileHTML = `
                    <h2>My Profile</h2>
                    <div class="info-section">
                        <h3>Account Information</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Name</label>
                                <div class="value">${user.name}</div>
                            </div>
                            <div class="info-item">
                                <label>Role</label>
                                <div class="value">${user.role.toUpperCase()}</div>
                            </div>
                            <div class="info-item">
                                <label>${user.role === 'patient' ? 'National ID' : 'Employee ID'}</label>
                                <div class="value">${user.username}</div>
                            </div>
                            <div class="info-item">
                                <label>Email</label>
                                <div class="value">${user.email}</div>
                            </div>
                        </div>
                    </div>
                `;

                if (profile && user.role === 'patient') {
                    profileHTML += `
                        <div class="info-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3>Personal Information</h3>
                                <button class="btn btn-small" onclick="showEditProfile()">Edit Profile</button>
                            </div>
                            <div class="info-grid" id="profileDisplay">
                                <div class="info-item">
                                    <label>Date of Birth</label>
                                    <div class="value">${profile.date_of_birth ? new Date(profile.date_of_birth).toLocaleDateString() : 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <label>Age</label>
                                    <div class="value">${calculateAge(profile.date_of_birth)} years</div>
                                </div>
                                <div class="info-item">
                                    <label>Gender</label>
                                    <div class="value">${profile.gender || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <label>Phone</label>
                                    <div class="value">${profile.phone || 'N/A'}</div>
                                </div>
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <label>Address</label>
                                    <div class="value">${profile.address || 'N/A'}</div>
                                </div>
                            </div>
                            <div id="editProfileForm" class="hidden"></div>
                        </div>

                        <div class="info-section">
                            <h3>Medical Information</h3>
                            <div class="info-grid">
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <label>Allergies</label>
                                    <div class="value">${profile.allergies || 'None reported'}</div>
                                </div>
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <label>Chronic Conditions</label>
                                    <div class="value">${profile.chronic_conditions || 'None reported'}</div>
                                </div>
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <label>Current Medications</label>
                                    <div class="value">${profile.current_medications || 'None'}</div>
                                </div>
                            </div>
                        </div>

                        <div class="info-section">
                            <h3>Emergency Contact</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Name</label>
                                    <div class="value">${profile.emergency_contact_name || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <label>Phone</label>
                                    <div class="value">${profile.emergency_contact_phone || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <label>Relationship</label>
                                    <div class="value">${profile.emergency_contact_relationship || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                profileSection.innerHTML = profileHTML;
            } catch (error) {
                profileSection.innerHTML = `<h2>My Profile</h2><div class="alert alert-error">Error loading profile: ${error.message}</div>`;
            }
        }

        async function showEditProfile() {
            const response = await fetch(`${API_URL}/api/user/profile`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const profile = await response.json();

            document.getElementById('profileDisplay').classList.add('hidden');
            document.getElementById('editProfileForm').classList.remove('hidden');
            document.getElementById('editProfileForm').innerHTML = `
                <form id="updateProfileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editPhone" value="${profile.phone || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="editAddress">${profile.address || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Allergies</label>
                        <textarea id="editAllergies" placeholder="List any allergies...">${profile.allergies || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Chronic Conditions</label>
                        <textarea id="editConditions" placeholder="List any chronic conditions...">${profile.chronic_conditions || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Current Medications</label>
                        <textarea id="editMedications" placeholder="List current medications...">${profile.current_medications || ''}</textarea>
                    </div>
                    <button type="submit" class="btn btn-small">Save Changes</button>
                    <button type="button" class="btn btn-small btn-secondary" onclick="cancelEditProfile()">Cancel</button>
                </form>
            `;

            document.getElementById('updateProfileForm').addEventListener('submit', updateProfile);
        }

        async function updateProfile(e) {
            e.preventDefault();

            const updateData = {
                phone: document.getElementById('editPhone').value,
                address: document.getElementById('editAddress').value,
                allergies: document.getElementById('editAllergies').value,
                chronic_conditions: document.getElementById('editConditions').value,
                current_medications: document.getElementById('editMedications').value
            };

            try {
                const response = await fetch(`${API_URL}/api/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    alert('Profile updated successfully!');
                    await loadProfile();
                } else {
                    alert('Failed to update profile');
                }
            } catch (error) {
                alert('Error updating profile');
            }
        }

        function cancelEditProfile() {
            document.getElementById('profileDisplay').classList.remove('hidden');
            document.getElementById('editProfileForm').classList.add('hidden');
        }

        async function loadPatientRegistration() {
            const registerSection = document.getElementById('registerSection');
            if (!registerSection) return;
            
            registerSection.innerHTML = `
                <h2>Register New Patient</h2>
                <div id="registerAlert"></div>
                
                <form id="registerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="registerFirstName" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="registerLastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>National ID (10 digits) *</label>
                        <input type="text" id="registerNationalId" maxlength="10" pattern="[0-9]{10}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Phone *</label>
                            <input type="tel" id="registerPhone" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Birth *</label>
                            <input type="date" id="registerDob" required>
                        </div>
                        <div class="form-group">
                            <label>Gender *</label>
                            <select id="registerGender" required>
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address *</label>
                        <textarea id="registerAddress" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Emergency Contact Name *</label>
                        <input type="text" id="registerEmergencyName" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Emergency Contact Phone *</label>
                            <input type="tel" id="registerEmergencyPhone" required>
                        </div>
                        <div class="form-group">
                            <label>Relationship *</label>
                            <input type="text" id="registerEmergencyRelationship" placeholder="e.g., Spouse, Parent" required>
                        </div>
                    </div>
                    <button type="submit" class="btn">Register Patient</button>
                </form>
            `;

            document.getElementById('registerForm').addEventListener('submit', handlePatientRegistration);
        }

        async function handlePatientRegistration(e) {
            e.preventDefault();
            
            const formData = {
                national_id: document.getElementById('registerNationalId').value,
                first_name: document.getElementById('registerFirstName').value,
                last_name: document.getElementById('registerLastName').value,
                email: document.getElementById('registerEmail').value,
                phone: document.getElementById('registerPhone').value,
                date_of_birth: document.getElementById('registerDob').value,
                gender: document.getElementById('registerGender').value,
                address: document.getElementById('registerAddress').value,
                emergency_contact_name: document.getElementById('registerEmergencyName').value,
                emergency_contact_phone: document.getElementById('registerEmergencyPhone').value,
                emergency_contact_relationship: document.getElementById('registerEmergencyRelationship').value
            };

            try {
                const response = await fetch(`${API_URL}/api/nurse/register-patient`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('registerAlert', 'Patient registered successfully! They can now login with their national ID and set a password.', 'success');
                    document.getElementById('registerForm').reset();
                } else {
                    showAlert('registerAlert', data.detail || data.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showAlert('registerAlert', 'Connection error. Please try again.', 'error');
            }
        }

        async function searchPatient() {
            const nationalId = document.getElementById('searchNationalId').value.trim();
            
            if (nationalId.length !== 10 || !/^\d+$/.test(nationalId)) {
                showAlert('triageAlert', 'Please enter a valid 10-digit National ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/search/patient?national_id=${nationalId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const patient = data.patient;
                    document.getElementById('patientInfoDisplay').classList.remove('hidden');
                    document.getElementById('patientInfoDisplay').innerHTML = `
                        <div class="alert alert-success">
                            <strong>Patient Found:</strong> ${patient.name} (Age: ${patient.age}, Gender: ${patient.gender})
                            <br><small>Previous Visits: ${patient.previous_visits}</small>
                        </div>
                        <div class="info-grid" style="margin-bottom: 20px;">
                            <div class="info-item">
                                <label>Allergies</label>
                                <div class="value">${patient.allergies || 'None'}</div>
                            </div>
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <label>Chronic Conditions</label>
                                <div class="value">${patient.chronic_conditions || 'None'}</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('triageForm').classList.remove('hidden');
                    document.getElementById('triageNationalId').value = nationalId;
                } else {
                    showAlert('triageAlert', data.message || 'Patient not found. Please ask them to register first.', 'error');
                    document.getElementById('patientInfoDisplay').classList.add('hidden');
                    document.getElementById('triageForm').classList.add('hidden');
                }
            } catch (error) {
                showAlert('triageAlert', 'Error searching for patient. Please try again.', 'error');
            }
        }

        async function handleTriageSubmit(e) {
            e.preventDefault();
            
            const triageData = {
                patient_national_id: document.getElementById('triageNationalId').value,
                heart_rate: parseInt(document.getElementById('triageHeartRate').value),
                blood_pressure_systolic: parseInt(document.getElementById('triageBPSystolic').value),
                blood_pressure_diastolic: parseInt(document.getElementById('triageBPDiastolic').value),
                temperature: parseFloat(document.getElementById('triageTemperature').value),
                respiratory_rate: parseInt(document.getElementById('triageRespiratoryRate').value),
                oxygen_saturation: parseInt(document.getElementById('triageOxygenSat').value),
                pain_level: parseInt(document.getElementById('triagePainLevel').value),
                consciousness_level: document.getElementById('triageConsciousness').value,
                patient_complaint: document.getElementById('triageComplaint').value,  // Changed from chief_complaint
                arrival_mode: document.getElementById('triageArrivalMode').value
            };

            try {
                const response = await fetch(`${API_URL}/api/triage/predict`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(triageData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('triageAlert', `
                        <strong>‚úÖ Triage Completed Successfully!</strong><br>
                        Patient: ${data.patient_name} (${data.patient_id})<br>
                        Severity: <span class="severity-badge ${getSeverityClass(data.severity)}">${data.severity}</span><br>
                        Confidence: ${data.confidence.toFixed(1)}%<br>
                        Estimated Wait Time: ${formatWaitTime(data.estimated_wait_time_minutes)}
                    `, 'success');
                    
                    document.getElementById('triageForm').reset();
                    document.getElementById('searchNationalId').value = '';
                    document.getElementById('patientInfoDisplay').classList.add('hidden');
                    document.getElementById('triageForm').classList.add('hidden');
                    
                    setTimeout(() => loadNurseDashboard(), 2000);
                } else {
                    showAlert('triageAlert', data.detail || data.message || 'Triage submission failed', 'error');
                }
            } catch (error) {
                showAlert('triageAlert', 'Connection error. Please try again.', 'error');
            }
        }

        async function loadTriageForm() {
            const triageSection = document.getElementById('triageSection');
            if (!triageSection) return;
            
            triageSection.innerHTML = `
                <h2>Perform Triage Assessment</h2>
                <div id="triageAlert"></div>
                
                <div class="info-section">
                    <h3>Step 1: Search Patient</h3>
                    <div class="search-box">
                        <input type="text" id="searchNationalId" placeholder="Enter Patient National ID (10 digits)" maxlength="10" pattern="[0-9]{10}">
                        <button class="btn btn-small" onclick="searchPatient()">Search Patient</button>
                    </div>
                    <div id="patientInfoDisplay" class="hidden"></div>
                </div>

                <form id="triageForm" class="hidden" onsubmit="handleTriageSubmit(event)">
                    <input type="hidden" id="triageNationalId">
                    
                    <div class="info-section">
                        <h3>Step 2: Record Vital Signs</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Heart Rate (bpm) * <small style="color: #888;">[40-200]</small></label>
                                <input type="number" id="triageHeartRate" min="40" max="200" placeholder="Normal: 60-100 bpm" required>
                            </div>
                            <div class="form-group">
                                <label>Blood Pressure Systolic (mmHg) * <small style="color: #888;">[60-250]</small></label>
                                <input type="number" id="triageBPSystolic" min="60" max="250" placeholder="Normal: 90-120 mmHg" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Blood Pressure Diastolic (mmHg) * <small style="color: #888;">[40-150]</small></label>
                                <input type="number" id="triageBPDiastolic" min="40" max="150" placeholder="Normal: 60-80 mmHg" required>
                            </div>
                            <div class="form-group">
                                <label>Temperature (¬∞C) * <small style="color: #888;">[35.0-42.0]</small></label>
                                <input type="number" id="triageTemperature" step="0.1" min="35" max="42" placeholder="Normal: 36.5-37.5¬∞C" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Respiratory Rate (breaths/min) * <small style="color: #888;">[8-40]</small></label>
                                <input type="number" id="triageRespiratoryRate" min="8" max="40" placeholder="Normal: 12-20 breaths/min" required>
                            </div>
                            <div class="form-group">
                                <label>Oxygen Saturation (%) * <small style="color: #888;">[70-100]</small></label>
                                <input type="number" id="triageOxygenSat" min="70" max="100" placeholder="Normal: 95-100%" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pain Level * <small style="color: #888;">[0-10: 0=No pain, 10=Worst pain]</small></label>
                                <input type="number" id="triagePainLevel" min="0" max="10" placeholder="0 = No pain, 10 = Worst pain" required>
                            </div>
                            <div class="form-group">
                                <label>Consciousness Level *</label>
                                <select id="triageConsciousness" required>
                                    <option value="">Select...</option>
                                    <option value="Alert">Alert (Fully conscious and responsive)</option>
                                    <option value="Drowsy">Drowsy (Sleepy, responds to verbal/pain)</option>
                                    <option value="Unresponsive">Unresponsive (No response)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>Step 3: Additional Information</h3>
                        <div class="form-group">
                            <label>Patient Complaint *</label>
                            <textarea id="triageComplaint" placeholder="Describe the patient's main complaint..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Arrival Mode *</label>
                            <select id="triageArrivalMode" required>
                                <option value="">Select...</option>
                                <option value="Walk-in">Walk-in</option>
                                <option value="Ambulance">Ambulance</option>
                                <option value="Police">Police</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn">Submit Triage Assessment</button>
                </form>
            `;
        }

        async function loadAnalytics() {
            const analyticsSection = document.getElementById('analyticsSection');
            if (!analyticsSection) return;
            
            analyticsSection.innerHTML = '<h2>System Analytics</h2><div class="loading">Loading analytics data</div>';

            try {
                const response = await fetch(`${API_URL}/api/triage/patients`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (!data.patients || data.patients.length === 0) {
                    analyticsSection.innerHTML = '<h2>System Analytics</h2><div class="alert alert-info">No data available for analytics.</div>';
                    return;
                }

                const severityCounts = {
                    'Critical': 0,
                    'Emergency': 0,
                    'Urgent': 0,
                    'Semi-Urgent': 0,
                    'Non-Urgent': 0
                };

                const statusCounts = {
                    'Waiting': 0,
                    'In Treatment': 0,
                    'Completed': 0,
                    'Discharged': 0,
                    'Referred': 0
                };

                data.patients.forEach(p => {
                    if (severityCounts[p.severity] !== undefined) {
                        severityCounts[p.severity]++;
                    }
                    if (statusCounts[p.status] !== undefined) {
                        statusCounts[p.status]++;
                    }
                });

                const maxSeverity = Math.max(...Object.values(severityCounts), 1);
                const maxStatus = Math.max(...Object.values(statusCounts), 1);

                analyticsSection.innerHTML = `
                    <h2>System Analytics</h2>
                    
                    <div class="chart-container">
                        <h3>Patients by Severity Level</h3>
                        ${Object.entries(severityCounts).map(([severity, count]) => `
                            <div class="chart-bar">
                                <div class="chart-label">${severity}</div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill ${getSeverityClass(severity)}" 
                                         style="width: ${(count / maxSeverity) * 100}%">
                                        ${count}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="chart-container">
                        <h3>Patients by Status</h3>
                        ${Object.entries(statusCounts).map(([status, count]) => `
                            <div class="chart-bar">
                                <div class="chart-label">${status}</div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill ${getStatusClass(status)}" 
                                         style="width: ${(count / maxStatus) * 100}%; background: ${getStatusColor(status)}">
                                        ${count}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card">
                            <h3>Total Patients</h3>
                            <div class="value">${data.patients.length}</div>
                        </div>
                        <div class="stat-card critical">
                            <h3>Critical Cases</h3>
                            <div class="value">${severityCounts['Critical']}</div>
                        </div>
                        <div class="stat-card warning">
                            <h3>Waiting for Treatment</h3>
                            <div class="value">${statusCounts['Waiting']}</div>
                        </div>
                        <div class="stat-card success">
                            <h3>Completed Today</h3>
                            <div class="value">${statusCounts['Completed']}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                analyticsSection.innerHTML = `<h2>System Analytics</h2><div class="alert alert-error">Error loading analytics: ${error.message}</div>`;
            }
        }

        async function openPatientModal(patientId) {
            document.getElementById('patientModal').classList.add('active');
            document.getElementById('modalBody').innerHTML = '<div class="loading">Loading patient details</div>';

            try {
                const response = await fetch(`${API_URL}/api/triage/patient/${patientId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch patient details');
                const data = await response.json();
                const patient = data.patient;
                const vitals = patient.vital_signs;

                const severityClass = getSeverityClass(patient.severity);
                const statusClass = getStatusClass(patient.status);

                let modalHTML = `
                    <div class="info-section">
                        <h3>Patient Information</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Patient ID</label>
                                <div class="value">${patient.patient_id}</div>
                            </div>
                            <div class="info-item">
                                <label>Name</label>
                                <div class="value">${patient.name}</div>
                            </div>
                            <div class="info-item">
                                <label>Age</label>
                                <div class="value">${patient.age} years</div>
                            </div>
                            <div class="info-item">
                                <label>Gender</label>
                                <div class="value">${patient.gender}</div>
                            </div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>Triage Assessment</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Severity</label>
                                <div class="value"><span class="severity-badge ${severityClass}">${patient.severity}</span></div>
                            </div>
                            <div class="info-item">
                                <label>Status</label>
                                <div class="value"><span class="status-badge ${statusClass}">${patient.status}</span></div>
                            </div>
                            <div class="info-item">
                                <label>Confidence</label>
                                <div class="value">${patient.confidence.toFixed(1)}%</div>
                            </div>
                            <div class="info-item">
                                <label>Arrival Mode</label>
                                <div class="value">${patient.arrival_mode}</div>
                            </div>
                            <div class="info-item">
                                <label>Triage Time</label>
                                <div class="value">${formatDateTime(patient.timestamp)}</div>
                            </div>
                            <div class="info-item">
                                <label>Nurse</label>
                                <div class="value">${patient.nurse_name || patient.created_by}</div>
                            </div>
                            ${patient.estimated_wait_time ? `
                            <div class="info-item">
                                <label>Est. Wait Time</label>
                                <div class="value">${formatWaitTime(patient.estimated_wait_time)}</div>
                            </div>
                            ` : ''}
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <label>Patient Complaint</label>
                                <div class="value">${patient.patient_complaint}</div>
                            </div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>Vital Signs</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Heart Rate</label>
                                <div class="value">${vitals.heart_rate} bpm</div>
                            </div>
                            <div class="info-item">
                                <label>Blood Pressure</label>
                                <div class="value">${vitals.blood_pressure_systolic}/${vitals.blood_pressure_diastolic} mmHg</div>
                            </div>
                            <div class="info-item">
                                <label>Temperature</label>
                                <div class="value">${vitals.temperature}¬∞C</div>
                            </div>
                            <div class="info-item">
                                <label>Respiratory Rate</label>
                                <div class="value">${vitals.respiratory_rate} breaths/min</div>
                            </div>
                            <div class="info-item">
                                <label>Oxygen Saturation</label>
                                <div class="value">${vitals.oxygen_saturation}%</div>
                            </div>
                            <div class="info-item">
                                <label>Pain Level</label>
                                <div class="value">${vitals.pain_level}/10</div>
                            </div>
                            <div class="info-item">
                                <label>Consciousness</label>
                                <div class="value">${vitals.consciousness_level}</div>
                            </div>
                        </div>
                    </div>
                `;

                if (patient.doctor_notes && currentUser.role !== 'patient') {
                    modalHTML += `
                        <div class="info-section">
                            <h3>Doctor Notes</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${patient.doctor_notes}</div>
                        </div>
                    `;
                }

                if (currentUser.role === 'doctor') {
                    modalHTML += `
                        <div class="info-section">
                            <h3>Update Patient Status</h3>
                            <form id="updateStatusForm" onsubmit="updatePatientStatus(event, '${patient.patient_id}')">
                                <div class="form-group">
                                    <label>Select Status *</label>
                                    <select id="statusSelect" required>
                                        <option value="">Choose new status...</option>
                                        <option value="In Treatment" ${patient.status === 'In Treatment' ? 'selected' : ''}>In Treatment</option>
                                        <option value="Completed" ${patient.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                        <option value="Discharged" ${patient.status === 'Discharged' ? 'selected' : ''}>Discharged</option>
                                        <option value="Referred" ${patient.status === 'Referred' ? 'selected' : ''}>Referred</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Doctor Notes (Optional)</label>
                                    <textarea id="doctorNotes" placeholder="Add notes about diagnosis, treatment, or recommendations..." rows="4"></textarea>
                                </div>
                                <button type="submit" class="btn btn-small">Update Status</button>
                            </form>
                        </div>
                    `;
                }

                document.getElementById('modalBody').innerHTML = modalHTML;
            } catch (error) {
                document.getElementById('modalBody').innerHTML = `<div class="alert alert-error">Error loading patient details: ${error.message}</div>`;
            }
        }

        function closeModal() {
            document.getElementById('patientModal').classList.remove('active');
        }

        async function updatePatientStatus(event, patientId) {
            event.preventDefault();
            
            const newStatus = document.getElementById('statusSelect').value;
            const doctorNotes = document.getElementById('doctorNotes').value.trim();

            if (!newStatus) {
                alert('Please select a status');
                return;
            }

            try {
                let url = `${API_URL}/api/triage/patient/${patientId}?status=${encodeURIComponent(newStatus)}`;
                if (doctorNotes) {
                    url += `&doctor_notes=${encodeURIComponent(doctorNotes)}`;
                }

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Status updated to: ${newStatus}`);
                    closeModal();
                    if (currentUser.role === 'doctor') await loadDoctorDashboard();
                    else if (currentUser.role === 'admin') await loadAdminDashboard();
                } else {
                    alert(data.detail || data.message || 'Failed to update status');
                }
            } catch (error) {
                alert('Connection error. Please try again.');
            }
        }

        document.getElementById('patientModal').addEventListener('click', (e) => {
            if (e.target.id === 'patientModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>